# Среда разработки

## Структура

Среда разработки перенесена в собственный Docker-контейнер на основе
[официального образа Python](https://hub.docker.com/_/python/) версии 3.11.

Основные структурные элементы среды разработки:

1. Python
2. Git
3. Poetry
4. DVC
5. Jupyter Notebook
6. Другие пакеты Python.

Для работы DVC необходим настроенный Git. К счастью,
[Официальный образ Python](https://hub.docker.com/_/python/) "из коробки"
содержит Git, поэтому самостоятельная установка Git для
взаимодействия с репозиторием не требуется, достаточно только настроить его.

В качестве внешнего хранилища DVC используется Google Drive. Соответствующие
настройки DVC находятся в `/.dvc/config` и `/.dvc/config.local` (каталог проекта
считать корневым). Токен для подключения к DVC Google Drive должен находиться
по адресу `/.gdrive/credentials.json`

Пользователь может получить доступ к среде разработки как через командную строку
контейнера, так и с помощью Jupyter Notebook.
Директория проекта монтируется к контейнеру со средой разработки (к каталогу
`/dockeruser/comp_ds_prj`) как
[bind-mount](https://docs.docker.com/storage/bind-mounts/).
Подробнее в разделе [Запуск](#запуск).

На иллюстрации ниже предствалена структура среды разработки.

![Среда разработки](/docs/figures/dev_env_container.svg)

## Пользователи

Работа в контейнере Docker под учетной записью привелигированного
пользователя `root`, считается небезопасной и нежелательна, поэтому в
процессе сборки образа создаётся непривелигорованный пользователь `dockeruser`,
от имени которого будут выполняться все действия в контейнере.

Работа в контейнере под пользователем отличным от `root` и использование
[bind-mounts](https://docs.docker.com/storage/bind-mounts/) будут приводить к
тому, что внутренний пользователь контейнера (`dockeruser`) будет пытаться
получить доступ к файлам в каталоге проекта, собственником которых является
пользователь, создавший контейнер. Скорее всего у внитреннего пользователя
контейнера не будет правл на запись и/или чтение файлов в директории проекта.
У пользователя, создавшего контейнер, в свою очередь, скорее всего, не будет
прав запись и/или чтение файлов, которые создал внутренний пользователь
контейнера. Такая несогласованность в правах доступа будет приводить к тому,
что команды, выполняемые в контейнере, и связанные с записью и/или чтением
файлов будут приводить к ошибке? содержащей в сообщение `permission denied`.

Чтобы избежать таких ситуаций проще всего разрешить чтение и запись всех файлов
каталога проекта для всех пользователей. Сделать это можно выполнив следующую
команду из каталога проекта (`../Project/` - каталог проекта):

```shell
user@user-pc:~/Project$ sudo chmod -R a+rw ../Project/
```

## Сборка образа

Шаги сборки образа описаны в [Dockerfile](/Dockerfile), расположенном в корне
репозитория. Этапы сборки образа можно описать следующим образом:

1. Загрузка базового образа -
[официальный образ Python](https://hub.docker.com/_/python/)
1. Создание группы пользователей `dockeruser`.
1. Созадние пользователя `dockeruser` без прав администратора. Нужно иметь в
виду, что домашний каталог пользователя `dockeruser` размещается по адресу
`/dockeruser/`, где `dockeruser` - имя созданного пользователя, далее к этому
пути будет привязана установка менеджера зависимостей Poetry и каталог с
проектом.
1. Переключение пользователя на `dockeruser`. Далее все операции выполняются от
его имени.
1. Настройка параметров Git: `user.name` и `user.email`.
1. Установка Poetry.
1. Добавление Poetry в `Path`.
1. Настройка Poetry - установка параметра `installer.max-workers`.
1. Переключение рабочего каталога на `/dockeruser/comp_ds_prj` - директорию с
проектом.
1. Копирование в `/dockeruser/comp_ds_prj` файлов `poetry.lock` и
`pyproject.toml` из корня репозитория.
1. Установка зависимостей из `poetry.lock` без модуля с исходниками проекта,
так как остальные файла из каталога проекта позже будут смонтированы в
`/dockeruser/comp_ds_prj` как
[bind-mount](https://docs.docker.com/storage/bind-mounts/).
1. Командой, исполняемой по умолчанию при запуске контейнера устанавливается
`/bin/bash`, чтобы пользователь мог сразу же получить доступ к командной строке.

[Dockerfile](/Dockerfile) параметризован. Ниже перечислены его параметры.
| Параметр | Описание                                                                                              | Значение по умолчанию          |
|----------|-------------------------------------------------------------------------------------------------------|--------------------------------|
| UNAME    | Имя пользователя, от имени которого будут выполняться действия в контейнере.                          | dockeruser                     |
| UID      | ID пользователя, указанного в UNAME.                                                                  | 1001                           |
| GID      | ID группы пользователя, указанного в UNAME.                                                           | 1001                           |
| GITUSER  | Имя пользователя, от которого будут совершаться комиты (значение параметра Git `user.name`).          | "Aleksei Bogachev"             |
| GITEMAIL | Email пользователя, от имени которого будут совершаться комиты (значение параметра Git `user.email`). | "bogachev.aleksey.m@gmail.com" |

Прежде чем запускать среду разработки (контейнер с ней) или создавать
[self-hosted runner для GitHub Actions](https://docs.github.com/en/actions/hosting-your-own-runners),
необходимо собрать образ контейнера среды разработки. Для этого в корне
репозитория расположен скрипт [build.sh](/build.sh), который задаёт параметры
образа, настраивает логирование процесса сборки в файл
`/logs/docker_build.log` и собирает образ.

[build.sh](/build.sh) задаёт следующие значения параметров для образа:

- `UID=$(id -u)` - параметру `UID` присваивается id  текущего пользователя;
- `GID=$(id -g)` - параметру `GID` присваивается id группы текущего
пользователя;
- `GITUSER="$(git config user.name)"` - параметру `GITUSER` присваивается
значение параметра `user.name` в настройках Git для текущего пользователя;
- `GITEMAIL="$(git config user.email)"` - параметру `GITEMAIL` присваивается
значение параметра `user.email` в настройках Git для текущего пользователя.

Скрипт [build.sh](/build.sh) нужно вызывать из корневого каталога репозитория
следующей командой:

```shell
user@user-pc:~/Project$ ./build.sh
```

## Запуск

Есть два варианта запуска среды разработки:

1. Запуск командной строки - скрипт [start.sh](/start.sh).
2. Запуск Jupyter Notebook - скрипт [jupyter.sh](/jupyter.sh).

### Start.sh

Скрипт выполняет следующие шаги:

1. Собирает образ, вызвав скрипт [build.sh](/build.sh).
2. Создаёт контейнер в интерактивном режиме и монтирует текущую директорию в
каталог контейнера `/dockeruser/comp_ds_prj` (см.
[bind-mount](https://docs.docker.com/storage/bind-mounts/)).
3. Запускает Bash в контейнере и передаёт управление пользователю.
4. После выхода пользователем из консоли, удаляет контейнер.

Скрипт [start.sh](/start.sh) нужно заускать из корневого каталога репозитория
следующей командой:

```shell
user@user-pc:~/Project$ ./start.sh
```

Также можно запустить скрипт [start.sh](/start.sh) и сразу же передать в
контейнер команду для исполнения. В таком случае, нужно передать команду как
аргумент скрипта:

```shell
user@user-pc:~/Project$ ./start.sh <команда пользователя>
```

например,

```shell
user@user-pc:~/Project$ ./start.sh poetry run dvc repro
```

В таком случае управление контейнер выполнит команду пользователя и заврешит
свою работу, после чего будет удалён.

### Jupyter.sh

Скрипт [jupyter.sh](/jupyter.sh) делает всё то же самое, что и
[start.sh](/start.sh), но вместо запуска Bash и передачи управления пользователю
он запускает сервер Jupyter Notebook на порте `8080`.

Скрипт [jupyter.sh](/jupyter.sh) нужно заускать из корневого каталога репозитория
следующей командой:

```shell
user@user-pc:~/Project$ ./jupyter.sh
```

После того как запустится сревер Jupyter Notebook, в командной строке
пользователю будет выведена ссылка с токеном, которую нужно будет скопировать в
браузер. После этого можно будет работать с Jupyter Notebook как обычно. На
рисунке ниже приведён пример выдачи в командной строке с выделенной ссылкой.

![Ссылка Jupyter Notebook](/docs/figures/jupyter_cmd_out_example.png)
